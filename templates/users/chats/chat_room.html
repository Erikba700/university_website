{% extends 'users/nav_bar.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat_room.css' %}">
<link rel="stylesheet" href="{% static 'css/chatBox.css' %}">
{% endblock %}

{% block content %}
<div class="chat-container">
    <h2 class="chat-room-title">Room: {{ room_name }}</h2>

    <div id="chat" class="chat-log">
        {% for message in messages %}
            <div class="message-box" data-id="{{ message.id }}">
                <div class="message-content">
                    <strong>{{ message.user.first_name }}</strong>
                    <p>{{ message.text }}</p>
                    <span class="timestamp">{{ message.timestamp|date:"H:i:s" }}</span>
                    <span class="message-options">
                        <button class="message-menu">•••</button>
                        <div class="message-actions">
                            <button class="delete-btn">Delete</button>
                        </div>
                    </span>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="chat-input-container">
        <input id="chat-message-input" type="text" placeholder="Enter message" class="chat-input">
        <button id="chat-message-submit" class="chat-button">Send</button>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script type="module" src="{% static 'js/fireBasePushNotifications.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const roomName = "{{ room_name }}";
        const studentPk = "{{ student_pk }}";
        const chatLog = document.getElementById('chat');
        const input = document.getElementById('chat-message-input');
        const submitButton = document.getElementById('chat-message-submit');

        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + roomName + '/'
        );

        chatSocket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            console.log('Message received:', data);
            appendMessage(data, data.message_id);
        };

        chatSocket.onerror = function (error) {
            console.error('WebSocket error:', error);
        };

        chatSocket.onclose = function (e) {
            console.warn('WebSocket closed unexpectedly.');
        };

        submitButton.addEventListener('click', function (event) {
            const message = input.value;
            if (message) {
                console.log('Sending message:', message);

                chatSocket.send(JSON.stringify({
                    'message': message
                }));
                fetch('/send-notification/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: JSON.stringify({
                        'registration_id': '{{ recipient_registration_id }}',  // Recipient's Firebase token
                        'title': 'New message from {{ request.user.first_name }}',
                        'body': message
                    })
                }).then(response => response.json())
                  .then(data => console.log('Notification sent:', data))
                  .catch(error => console.error('Error sending notification:', error));
                input.value = '';
                input.focus();
            }
        });

        input.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitButton.click();
            }
        });

        function appendMessage(data, messageId) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message-box';
            messageElement.setAttribute('data-id', messageId);

            messageElement.innerHTML = `
                <div class="message-content">
                    <p>${data.message}</p>
                    <span class="timestamp">${data.timestamp}</span>
                    <span class="message-options">
                        <button class="message-menu">•••</button>
                        <div class="message-actions">
                            <button class="delete-btn">Delete</button>
                        </div>
                    </span>
                </div>
            `;

            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight;

            const deleteBtn = messageElement.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', function () {
                deleteMessage(messageId);
            });
        }

        function deleteMessage(messageId) {
            const messageElement = document.querySelector(`.message-box[data-id="${messageId}"]`);
            if (messageElement) {
                messageElement.remove();

                fetch(`/chat/delete/${messageId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(response => {
                    if (!response.ok) {
                        console.error('Failed to delete message.');
                    }
                }).catch(error => console.error('Error:', error));
            }
        }

        input.focus();

    });

</script>
{% endblock %}
